<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>catégorisation d'un flux d'image</title>

    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css">
    <script type="text/javascript" src="../js/d3.v5.min.js"></script>
    <script type="text/javascript" src="../js/jquery.min.js"></script>
    <script type="text/javascript" src="../js/site.js"></script>
    <script type="text/javascript" src="../js/polarclock.js"></script>
    <script type="text/javascript" src="../js/cartoaxes.js"></script>

    <script type="text/javascript" src="../font/font-awesome/all.min.js"></script>

    <link href="../css/carousel.css" rel="stylesheet">
    <link href="../css/sonar.css" rel="stylesheet">

    <style>
        body {
            font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
        }

        .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        @media (min-width: 768px) {
            .bd-placeholder-img-lg {
                font-size: 3.5rem;
            }
        }

        .bg-dark {
            background-color: #000000 !important;
        }

        .logo {
            vertical-align: top;
            height: 40px;
        }

        @font-face {
            font-family: "Quantify";
            src: url("../fonts/quantify/Quantify.ttf");
        }

        .logoTxt {
            vertical-align: sub;
            font-family: "Quantify";
        }

        .container {
            font-size: small;
        }

        .modal-content {
            background-color: black;
        }
    </style>

</head>

<body id="dummybodyid">
    <header>
        <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
            <a class="navbar-brand" href="#">
                <img class='logo' src="../svg/logo-sonar.svg" alt="logo-sonar" />
                <span class='logoTxt'>FLUX IMAGES</span>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse"
                aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-home"></i></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-user-edit"></i>
                            <span id='txtUti'></span>
                            <span id='btnConnexion'></span>
                        </a>
                    </li>
                </ul>
                <div class="dropdown-divider"></div>                
                <div class="form-inline mt-2 mt-md-0 mr-3">
                    <!--
                    <label id='lblSrcFlux' for="inSrcFlux">Source du flux IIIF&nbsp;<i
                            class="far fa-question-circle"></i>&nbsp;</label>
                    <input class="form-control mr-sm-2" type="text" id="inSrcFlux">
                    -->
                    <label for="optSrcFlux">Source du flux IIIF&nbsp;
                    <i class="far fa-question-circle"></i>&nbsp;</label>
                    <select class="form-control" id="optSrcFlux">
                    <option value='https://jardindesconnaissances.univ-paris8.fr/smel/omk/iiif/collection/1496' >Visages SMEL</option>
                    <option value='https://jardindesconnaissances.univ-paris8.fr/smel/omk/iiif/collection/1' >Tout SMEL</option>
                    <option value='https://jardindesconnaissances.univ-paris8.fr/ADACEMU/omk/iiif/collection/63' >Illustrations de thèse</option>
                    <option value='https://jardindesconnaissances.univ-paris8.fr/ValArNum/omks/iiif/collection/151682' >Reportages photographiques des présidences de la république française</option>      
                    <option value='../../data/SMEL/iiif-smel1.json' >Tests locaux</option>
                    </select>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="ckAleaTaille">
                        <label class="form-check-label" for="ckAleaTaille">
                            Taille aléatoire
                        </label>
                    </div>
                    <label for="optListeCpt">Liste des concepts</label>
                    <select class="form-control" id="optListeCpt">
                    <option value='bon,mauvais' >bon et mauvais</option>
                    <option value='vide,actuel,virtuel,signe,être,chose' >IEML</option>
                    <option value='Ciel,Tonnerre,Eau,Montagne,Terre,Vent,Feu,Brume' >Yi Jing : élémentaires</option>
                    <option value="le Créatif - le Ciel,le Réceptif,la Difficulté initiale,la Folie juvénile,l'Attente,le Conflit,l'Armée,la Solidarité-  l'Union,le Pouvoir d'apprivoisement du petit,la Marche,la Paix,la Stagnation,la Communauté avec les hommes,le Grand Avoir,l'Humilité,l'Enthousiasme,La Suite,le Travail sur ce qui est corrompu,l'Approche,la Contemplation,Mordre au travers,la Grâce,l'Éclatement,le Retour,l'Innocence,le Pouvoir d'apprivoisement du grand,les Commissures des lèvres,la Prépondérance du grand,l'Insondable,le Feu,l'Influence,la Durée,la Retraite,la Puissance du grand,le Progrès,l'Obscurcissement de la lumière,la Famille,l'Opposition,l'Obstacle,la Libération,la Diminution,l'Augmentation,la Percée,Venir à la rencontre,le Rassemblement,la Poussée vers le haut,l'Accablement,le Puits,la Révolution,le Chaudron,l'Ébranlement,la Montagne,le Développement,l'Épousée,Abondance,le Voyageur,le Doux,le Lac,La Dispersion,la Limitation,la Vérité intérieure,la Prépondérance du Petit,Après l'accomplissement,Avant l'accomplissement" >Yi Jing : hexagrammes</option>                    
                    <option value='乾,坤,震,坎,艮,巽,離,兌' >易静：小学</option>
                    </select>                                        
                    <label for="inListeConcept">Vos concepts séparés par une ,</label>
                    <input class="form-control mr-sm-2" type="text" id="inListeConcept" value="">

                    <button id='btnSrcFlux' class="btn btn-outline-success my-2 my-sm-0" type="submit">Charger</button>
                </div>
                <div class="form-inline mt-2 mt-md-0 mr-3">
                </div>
                <div class="dropdown-divider"></div>
                <div class="form-inline mt-2 mt-md-0">
                    <input class="form-control mr-sm-2" type="text" placeholder="Chercher" aria-label="Chercher">
                    <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Trouver</button>
                </div>

                <img src="../svg/logo-paragraphe-blanc.svg" alt="logo-paragraphe" style="height:40px;" />
                <i class="fab fa-creative-commons"></i>&nbsp;<i class="fab fa-creative-commons-zero"></i>
            </div>
        </nav>
    </header>

    <main role="main">

        <div id="carouselEvals" class="carousel slide" data-ride="carousel">
            <ol class="carousel-indicators" id="car-ind">
            </ol>
            <div class="carousel-inner" id="car-inn">
            </div>

            <a class="carousel-control-prev" href="#carouselEvals" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#carouselEvals" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </a>
        </div>


        <div class="container">

            <div class="row" id='cartoEval'>
                <svg>
                    <defs>
                        <linearGradient id="linear-gradient" y1="0.5" x2="1" y2="0.5" gradientUnits="objectBoundingBox">
                            <stop offset="0" stop-color="#54d6ff"></stop>
                            <stop offset="1" stop-color="#5fff84"></stop>
                        </linearGradient>
                        <linearGradient id="linear-gradient-2" x1="0.005" y1="0.585" x2="0.991" y2="0.585"
                            xlink:href="#linear-gradient">
                        </linearGradient>
                        <linearGradient id="center-gradient" x1="0.717" y1="1" x2="0" y2="1"
                            gradientUnits="objectBoundingBox">
                            <stop offset="0" stop-color="#5ffd8a"></stop>
                            <stop offset="0.65" stop-color="#58e6ce"></stop>
                            <stop offset="1" stop-color="#55daf2"></stop>
                        </linearGradient>
                        <linearGradient id="degraxeH" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop stop-color="rgb(173, 158, 253)" offset="0%"></stop>
                            <stop stop-color="rgb(252, 161, 205)" offset="100%"></stop>
                        </linearGradient>
                        <linearGradient id="degraxeV" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop stop-color="rgb(3, 246, 162)" offset="0%"></stop>
                            <stop stop-color="rgb(84, 214, 255)" offset="100%"></stop>
                        </linearGradient>
                    </defs>
                </svg>

            </div><!-- /.row -->

        </div><!-- /.container -->

        <!-- FOOTER -->
        <footer class="container">
        </footer>
    </main>


    <!-- Fenêtre modale pour le temps de chargement -->
    <div class="modal fade" id="modWait" tabindex="-1" role="dialog" aria-labelledby="modWaitLbl" aria-hidden="true">
        <div class="modal-dialog modal-full" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modWaitLbl">Merci de patienter...</h5>
                </div>
                <div class="modal-body" style="height: 180px;">
                    <div id="loader" style="display:block;"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>


    <script src="../js/popper.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script>
        var idBase = '<?php echo $this->idBase; ?>',
            uti = <?php echo $this->uti; ?>,
            //defSrcFlux = 'http://gapai.univ-paris8.fr/smel/omk/iiif/collection/1',
            //defSrcFlux = 'https://jardindesconnaissances.univ-paris8.fr/smel/omk/iiif/collection/1',
            //collection des visages
            defSrcFlux = 'https://jardindesconnaissances.univ-paris8.fr/smel/omk/iiif/collection/1496',
            //pour les tests
            //defSrcFlux = '../../data/SMEL/iiif-smel1.json',
            height = window.innerHeight,
            width = window.innerWidth,
            svg, pc, ca, tofEval, geo=false;

        //récupère la géolocalisation de l'utilisateur
        if (navigator.geolocation) {
	        navigator.geolocation.getCurrentPosition(function(p){
                geo = p;
            });
	    }


        //gestion des événements
        /*
        d3.select('#inSrcFlux').attr('value', defSrcFlux);
        d3.select('#lblSrcFlux')
            .on('click', function () {
                console.log('affiche les information sur les flux');
            });
        */
        d3.select('#btnSrcFlux')
            .on('click', function () {
                showCartoHorlo();
                //let src = document.getElementById("inSrcFlux").value;
                let src = document.getElementById("optSrcFlux").value;                
                console.log('Charge les images du flux IIIF :' + src);                
                showSource(src);
            });
        d3.select('#btnConnexion')
            .on('click', function () {
                console.log("connexion ou déconnexion de l'utilisateur");
            });

        showUti();

        function showUti() {
            d3.select('#txtUti').html(uti.login);
            let btn = '<i class="fas fa-sign-in-alt"></i>';
            if (uti.uti_id != 1) btn = '<i class="fas fa-sign-in-alt"></i>';
            d3.select('#btnConnexion').html(btn);
        }

        function showSource(src) {
            $('.navbar-collapse').collapse('hide');
            $('#modWait').modal('show');
            //
            $.ajax({
                url: src,
                dataType: "json",
                method: "GET",
                error: function (error) {
                    console.log("Erreur : " + error.responseText);
                    $('#modWait').modal('hide');
                },
                success: function (data) {
                    console.log(data);
                    //ajoute les photo à la gallery
                    ajoutPhotosGallerie(data.manifests);
                    //ajoute la cartographie
                    if (!ca) showCartoHorlo(data['@id']);
                }
            });
        }

        function ajoutPhotosGallerie(tofs) {

            //mélange toutes les photos
            tofEval = d3.shuffle(tofs);

            // Remove old elements as needed.
            d3.select('#car-ind').selectAll('li').remove();
            d3.select('#car-inn').selectAll('div').remove();


            //Ajoute la photo à la gallerie
            var li = d3.select('#car-ind').selectAll('li')
                .data(tofEval).enter().append('li')
                .attr('data-target', "#carouselEvals")
                .attr('data-slide-to', function (d, i) {
                    return i;
                })
                .attr('class', function (d, i) {
                    if (i == 0) return 'active';
                });

            var items = d3.select('#car-inn').selectAll('div')
                .data(tofEval).enter().append('div')
                .style('max-height', height / 3 + "px")
                .attr('class', function (d, i) {
                    var c = 'carousel-item';
                    if (i == 0) c += ' active';
                    return c;
                });

            //code pour ajouter des images
            items.append('img')
                .attr('id', function (d, i) {
                    d.idImg = 'img_' + i;
                    return d.idImg;
                })
                .attr('class', 'd-block img-fluid')
                .style('max-height', height / 3 + "px");

            //code pour ajouter des svg
            items.append('svg')
                .attr('id', function (d, i) {
                    d.idSvg = 'svg_' + i;
                    return d.idSvg;
                })
                .style('width', "100%")
                .style('height', "100%")
                .append('rect')
                .attr('id', function (d, i) {
                    d.idRect = 'rect_' + i;
                    return d.idRect;
                })
                .style('width', '100%')
                .style('height', '100%')
                .style('position', 'absolute')
                .style('top', '0px')
                .style('fill-opacity', '0')
                .style('stroke-width', '4')
                .style('fill', 'none')
                .style('stroke', 'green');


            /*ajoute le descriptif
	    var block = items.append('div').attr('class', 'carousel-caption d-none d-md-block');
	    block.append('h3').text(function (d) {
	        return d.label;
	    });
	    block.append('h4').text(function (d) {
	        return d.idOmk;
	    });
	    block.append('p').append('a')
	        .attr('href', function (d) {
	            return d.original;
	        })
	        .attr('target', '_blank').text('original');
        */

            initCarousel();
        }

        function initCarousel() {

            //ajoute les événements
            $('#carouselEvals').on('slid.bs.carousel', function (e) {
                //
                if (!tofEval[e.to].infos) {
                    //$('.carousel').carousel('pause');                                
                    getTofIIIF(e.to);
                    $('#modWait').modal('hide');
                }
                ca.idDoc = tofEval[e.to]['@id'];
                console.log(e);
            })
            $('.carousel').carousel({
                interval: 5000
            })
            //$('.carousel').carousel();
            //$('.carousel').carousel('cycle');
            //$('.carousel').carousel(tofEval.length-1);		
            //$('.carousel').carousel('pause');                                

        }

        function getTofIIIF(num) {
            let d = tofEval[num];
            $.ajax({
                url: d['@id'],
                dataType: "json",
                method: "POST",
                error: function (error) {
                    console.log("getTofIIIF Erreur : " + error.responseText);
                },
                success: function (data) {
                    console.log(data);
                    d.infos = data;
                    let url = "";
                    //vérifie la présence de visage
                    d.infos.metadata.forEach(function (t) {
                        if (t.label == "faceAnnotations") {
                            url = getVisageTofIIIF(d, t);
                        }
                    })

                    //récupère l'image si pas de visage
                    if (url == "") {
                        let isAlea = document.getElementById("ckAleaTaille").checked;
                        url = getTailleTofIIIF(d,isAlea);
                        //url = d.infos.thumbnail["@id"];
                    }
                    //code pour ajouter une image HTML
                    d3.select("#" + d.idImg).attr('src', url);
                    /*code pour une image SVG
                    d3.select("#"+d.idSvg).append('image')
                        .attr('class','iiif')
                        .attr('x',0)
                        .attr('y',0)
                        .attr('xlink:href',url);
                    */
                    //précise l'url à la carto
                    ca.idDoc = url;
                    //récupère les data
                    ca.drawData();                    
                }
            });

        }


        function getTailleTofIIIF(d, alea) {
            //item vient de IIIF
            //récupère la position et la taille du rectangle
            let bb = d3.select('#' + d.idRect).node().getBBox();

            //calcule l'url IIIF
            let zoom = 2,
                minPixel = 0,
                imgOmk = d.infos.sequences[0].canvases[0].images[0].resource.service["@id"],
                w = d.infos.sequences[0].canvases[0].width, h = d.infos.sequences[0].canvases[0].height, img = {};
                img.r = 0;
            if (!d.images) d.images = [];
            if(alea){
                img.w = parseInt(w < bb.width ? bb.width * zoom : bb.width / zoom);
                img.h = parseInt(h < bb.height ? bb.height * zoom : bb.height / zoom);
                img.x = parseInt(d3.randomUniform(minPixel, w > img.w ? w - img.w : w)());
                img.y = parseInt(d3.randomUniform(minPixel, h > img.h ? h - img.h : h)());
            }else{
                img.w = parseInt(w);
                img.h = parseInt(h);
                img.x = 0;
                img.y = 0;
            }
            img.url = imgOmk + '/' + img.x + ',' + img.y + ',' + (img.w) + ',' + (img.h) + '/' 
                + parseInt(bb.width) + ',' + parseInt(bb.height) + '/' + img.r + '/default.jpg';
            console.log(img);
            d.images.push(img);

            return img.url;
        }

        function getVisageTofIIIF(d, t) {
            //item vient de IIIF
            //récupère la position et la taille du rectangle
            let bb = d3.select('#' + d.idRect).node().getBBox();

            //récupère a défitinition du visage
            let vs = JSON.parse('[' + t.value + ']');
            console.log(vs);

            let img, imgOmk = d.infos.sequences[0].canvases[0].images[0].resource.service["@id"];
            vs.forEach(function (v) {
                //calcule l'url IIIF        
                if (!d.images) d.images = [];
                img = {
                    'w': v.boundingPoly.vertices[1].x - v.boundingPoly.vertices[0].x,
                    'h': v.boundingPoly.vertices[2].y - v.boundingPoly.vertices[0].y,
                    'x': v.boundingPoly.vertices[0].x,
                    'y': v.boundingPoly.vertices[0].y,
                    'r': 0
                };
                img.url = imgOmk + '/' + img.x + ',' + img.y + ',' + (img.w) + ',' + (img.h) + '/' + parseInt(bb
                    .width) + ',' + parseInt(bb.height) + '/' + img.r + '/default.jpg';
                console.log(img);
                d.images.push(img);
            });
            return img.url;
        }

        function showCartoHorlo(id) {
            //récupère la taille du conteneur
            let c = document.getElementById('cartoEval');
            //calcul les tailles
            let spacing = 0.000001,
                w = width,
                h = height / 2, //w = c.clientWidth, h = c.clientHeight,        
                rayon = w < h ? w / 2 : h / 2;
            
            //suprime le composants existants
            d3.select(".cartoaxes").remove();
            d3.select(".polarclock").remove();

            svg = d3.select("#cartoEval svg")
                .attr("id", "svgGlobal")
                .attr("width", w)
                .attr("height", h);
            //ajoute la polar clock
            pc = new polarclock({
                'idSvg': 'svgGlobal',
                'spacing': spacing,
                'width': w,
                'height': h,
                'chrono': true,
                'nbCouche': 6
            });
            //récupère la structure
            let stct = document.getElementById('inListeConcept').value;
            if(!stct){
                stct = document.getElementById('optListeCpt').value;
            }
            stct = stct.split(',');
            //ajoute la carto axe            
            ca = new cartoaxes({
                'idSvg': 'svgGlobal',
                'tick': 0,
                'idDoc': id,
                'urlData':'../sonar/flux?q=getEvals',
                'typeSrc':'IIIF',
                'structure': stct,
                'fctGetGrad': pc.getInstantColors,
                'fctSavePosi': savePosi,
                'width': w,
                'height': h
            });
            //pc.toggleTimer();
            pc.resetTimer()
        }

        function savePosi(d) {
            $.post('../sonar/flux', {
                    'q': 'savePosi',
                    'type':'IIIF',
                    'geo':geo,
                    'dt': d                    
                }, function (data) {
                    console.log(data);
                }, "json")
                .fail(function (e) {
                    throw new Error("Sauvegarde imposible : " + e);
                })
                .always(function () {});
        }
        showCartoHorlo();
        //$('#modWait').modal('show');
        $('.navbar-collapse').collapse('show');
    </script>
</body>

</html>